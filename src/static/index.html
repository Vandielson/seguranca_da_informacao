<!doctype html>
<html lang="pt-br">
<head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width,initial-scale=1" />
    <title>PoC Segurança LLM</title>
    <style>
        body { font-family: Arial, sans-serif; margin: 18px; max-width: 980px; }
        .card { border: 1px solid #ddd; border-radius: 10px; padding: 14px; margin-bottom: 14px; }
        .row { display: flex; gap: 12px; flex-wrap: wrap; }
        label { display: block; font-size: 12px; color: #444; margin-bottom: 4px; }
        input, select, textarea, button { padding: 10px; border-radius: 8px; border: 1px solid #ccc; width: 100%; }
        textarea { min-height: 110px; }
        .col { flex: 1; min-width: 220px; }
        button { cursor: pointer; }
        pre { background: #fafafa; border: 1px solid #eee; padding: 10px; border-radius: 8px; overflow: auto; }
        .muted { color: #666; font-size: 12px; }
    </style>
</head>

<body>
<h2>PoC Segurança para LLM</h2>

<div class="card">
    <h3>Provedor de LLM</h3>

    <div class="row">
        <div class="col">
            <label for="provider">LLM_PROVIDER</label>
            <select id="provider">
                <option value="mock">mock</option>
                <option value="ollama">ollama</option>
                <option value="gemini">gemini</option>
            </select>
        </div>

        <div class="col">
            <label for="ollama_url">OLLAMA_URL</label>
            <input id="ollama_url" placeholder="http://localhost:11434" />
        </div>

        <div class="col">
            <label for="ollama_model">OLLAMA_MODEL</label>
            <input id="ollama_model" placeholder="llama3.1" />
        </div>
    </div>

    <div class="row" style="margin-top:10px;">
        <div class="col">
            <button id="save_provider">Salvar configuração</button>
            <div id="provider_status" class="muted" style="margin-top:8px;"></div>
        </div>

        <div class="col">
            <button id="test_ollama">Testar Ollama</button>
            <div id="test_status" class="muted" style="margin-top:8px;"></div>
        </div>
    </div>
</div>

<div class="card">
    <h3>Chat</h3>
    <label for="message">Mensagem</label>
    <textarea id="message" placeholder="Digite seu prompt aqui..."></textarea>

    <div class="row" style="margin-top:10px;">
        <div class="col"><button id="send">Enviar</button></div>
    </div>

    <h4>Resposta</h4>
    <pre id="output"></pre>

    <details style="margin-top:10px;">
        <summary>Controles aplicados (debug)</summary>
        <pre id="controls"></pre>
    </details>
</div>

<script>
    async function loadProvider() {
        const r = await fetch("/api/provider");
        const data = await r.json();
        document.getElementById("provider").value = data.provider || "mock";
        document.getElementById("ollama_url").value = data.ollama_url || "http://localhost:11434";
        document.getElementById("ollama_model").value = data.ollama_model || "llama3.1";
        document.getElementById("provider_status").textContent = `Atual: ${data.provider}`;
        document.getElementById("test_status").textContent = "";
    }

    async function saveProvider() {
        const provider = document.getElementById("provider").value;
        const ollama_url = document.getElementById("ollama_url").value;
        const ollama_model = document.getElementById("ollama_model").value;

        const r = await fetch("/api/provider", {
            method: "POST",
            headers: {"Content-Type":"application/json"},
            body: JSON.stringify({ provider, ollama_url, ollama_model })
        });

        const data = await r.json();
        document.getElementById("provider_status").textContent =
            data.ok ? `Salvo: ${data.provider} | ${data.ollama_url} | ${data.ollama_model}` : "Falha ao salvar.";
    }

    async function testOllama() {
        document.getElementById("test_status").textContent = "Testando...";
        const r = await fetch("/api/provider/test", { method: "POST" });
        const data = await r.json();

        if (data.ok) {
            document.getElementById("test_status").textContent =
                `OK: ${data.message} | Modelo: ${data.ollama_model} | URL: ${data.ollama_url} | Resp: ${String(data.sample_response || "").slice(0, 80)}`;
        } else {
            document.getElementById("test_status").textContent =
                `Falhou: ${data.message}` + (data.error ? ` | Erro: ${data.error}` : "");
        }
    }

    async function sendChat() {
        const message = document.getElementById("message").value.trim();
        if (!message) return;

        document.getElementById("output").textContent = "Enviando...";
        document.getElementById("controls").textContent = "";

        const r = await fetch("/chat", {
            method: "POST",
            headers: {"Content-Type":"application/json"},
            body: JSON.stringify({ message, user_role: "user" })
        });

        const data = await r.json();

        if (!r.ok) {
            document.getElementById("output").textContent = JSON.stringify(data, null, 2);
            return;
        }

        document.getElementById("output").textContent = data.response || "";
        document.getElementById("controls").textContent = JSON.stringify(data.controls_applied || [], null, 2);
    }

    document.getElementById("save_provider").addEventListener("click", saveProvider);
    document.getElementById("test_ollama").addEventListener("click", testOllama);
    document.getElementById("send").addEventListener("click", sendChat);

    loadProvider();
</script>

</body>
</html>
